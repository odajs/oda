<meta charset="utf-8">

<oda-jupyter-app></oda-jupyter-app>

<script type="module">
    import '/web/oda/oda.js';
    import { LZString } from './lib/lz-string.js';

    ODA({ is: 'oda-jupyter-app', imports: '@oda/button, ./jupyter.js',
        template: `
            <style>
                :host {
                    @apply --vertical;
                    @apply --flex;
                    overflow: hidden;
                    height: 100%;
                }
            </style>
            <div style="flex-wrap: wrap; display: flex; flex-direction: row-reverse; border: 1px solid gray; position: sticky; top: 0; background: white; z-index: 99; background: lightgray; margin: 1px">
                <oda-button @pointerdown="share" icon="games:share" title="share"></oda-button>
                <oda-button @tap="saveFile" icon="iconoir:save-floppy-disk" title="save"></oda-button>
                <oda-button for="load" @tap="this.$('#load').click()" icon="unicon:file-upload-alt" title="upload"></oda-button>
                <input id="load" type="file" style="display: none" @change="loadFile($event)"/>
                <oda-button @tap="hideBorder = !hideBorder" allow-toggle ::toggled="hideBorder" icon="box:i-border-none" title="hide border"></oda-button>
                <oda-button @tap="collapsedMode = !collapsedMode" allow-toggle ::toggled="collapsedMode" icon="carbon:collapse-all" title="collapsed mode"></oda-button>
                <oda-button @tap="readOnly = !readOnly" allow-toggle ::toggled="readOnly" icon="unicon:book-reader" title="readOnly"></oda-button>
                <oda-button @tap="clear" icon="iconoir:erase" title="clear"></oda-button>
                <oda-button @tap="document.location.reload()" icon="icons:refresh" title="reload"></oda-button>
            </div>
            <oda-jupyter id="jupyter" :src :show-border="!hideBorder" ::notebook :collapsed-mode :read-only :edit-mode></oda-jupyter>
        `,
        $public: {
            $pdp: true,
            src: './jupyter.json',
            lzs: '',
            notebook: { },
            collapsedMode: false,
            hideBorder: false,
            readOnly: false,
            editMode: false
        },
        ready() {
            const _location = window.location.href;
            this.lzs = _location.split('?lzs=')[1];
            try {
                this.lzs = LZString.decompressFromEncodedURIComponent(this.lzs);
                if (this.lzs) {
                    this.src = '';
                    this.notebook = JSON.parse(this.lzs);
                }
            } catch (err) { console.log(err) }
        },
        loadFile(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async e => this.notebook = JSON.parse(e.target.result);
            reader.readAsText(file, 'UTF-8');
            if (this.notebook)
                this.readOnly = this.notebook.readOnly;
        },
        async saveFile(e) {
            let str = JSON.stringify(this.notebook, null, '\t');
            if (!str) return;
            const blob = new Blob([str], { type: "text/plain" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = (this.notebook.label || 'oda-jupyter') + '.json';
            a.click();
        },
        clear() {
            if (window.confirm(`Do you really want delete current cell ?`))
                this.notebook = { };
        },
        share() {
            let str = JSON.stringify(this.notebook, null, 4);
            if (str) {
                str = LZString.compressToEncodedURIComponent(str);
                let url = import.meta.url.split('#?')[0];
                url = url + ('#?lzs=') + str;
                window.open(url, '_blank').focus();
            }
        }
    })

</script>
