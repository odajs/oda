<meta charset="UTF-8">
<title>TENSOR</title>
<oda-tensor></oda-tensor>
<script type="module">
    import '../../../oda.js';
    import Tensor from  './tensor.js';
    ODA({is: 'oda-tensor', imports: '@oda/app-layout, @oda/scheme-layout', extends: 'oda-app-layout',
        template:`
            <div vertical slot="left-panel" opened>
               <textarea flex ::value="program"></textarea>
               <oda-button no-flex @tap="build"  style="text-align: center; padding: 8px;">BUILD</oda-button>
            </div>
            <oda-scheme-layout :items slot="main" ></oda-scheme-layout>
        `,
        program:{
            $save: true,
            $def: ''
        },
        build(){
            const func = new Function('tensor', this.program);
            this.outputs = [func(tensor)];
        },
        outputs: [],
        get items() {
            let rez = { data:[], xMax:0, yMax:0, m:{}, n: new Map() }
            let addBl = (tensor, y) => {
                if (rez.n.get(tensor) === undefined) {
                    rez.m[y]??=0
                    rez.m[y]++
                    rez.n.set(tensor,rez.data.length)
                    let bind = tensor.children.map( (v,i) => { return { block: v, top: 0 } })
                    let obj = {
                        is: "oda-net-node",
                        x: rez.m[y],
                        y,
                        tensor,
                        pins: {
                            top: [{}],
                            bottom: (bind.length)? [{ bind }]:[],
                        }
                    }
                    rez.xMax = Math.max(rez.xMax,obj.x)
                    rez.yMax = Math.max(rez.yMax,obj.y)
                    rez.data.push(obj)
                    tensor.children.forEach((c, i) => addBl(c, obj.y+1));
                }
            }
            this.outputs.forEach( out => addBl(out,0))
            let [dX, dY] = [100, 150]
            rez.data.forEach(bl => {
                bl.x = ((2 * bl.x - 1) / rez.m[bl.y] ) * rez.xMax * dX
                if (bl.tensor.t === 'input')
                    bl.y++
                bl.y = (bl.y + 0.1) * dY
                if (bl.pins.bottom.length)
                    bl.pins.bottom[0].bind.forEach(b => b.block = rez.n.get(b.block));
            } )
            if (rez.data.length)
                rez.data[0].pins.top = [];
            return rez.data;
        }
    })

    ODA({ is: 'oda-net-node', imports: '@oda/button',
        template: /*HTML*/ `
            <style>
                :host {
                    @apply --border;
                }
                div{
                    padding: 4px;
                }
                oda-button{
                    font-size: xx-small;
                }
            </style>
            <div :error-invert="!!err" :dark="!err" class="horizontal">
                <oda-icon icon-size="16" :icon></oda-icon>
                <div class="flex">{{label}}</div>
                <div>{{shape}}</div>
            </div>
            <div ~if="!err" class="horizontal">
                <oda-button flex @tap="showData($event, tensor.data)">data</oda-button>
                <oda-button flex @tap="showData($event, tensor.grad)">grad</oda-button>
            </div>
            <div ~if="!!err" error class="flex" style="font-size: xx-small; flex-wrap: wrap;">{{err}}</div>

        `,
        get err(){
            return this.tensor.error;
        },
        get tensor(){
            return this.block.tensor;
        },
        get shape(){
            if (this.tensor.error)
                return 'ERROR';
            if (this.tensor.dim)
                return '['+this.tensor?.shape?.join(' x ')+']'
            return '= '+this.tensor.data.toLocaleString();
        },
        get label(){
            return this.tensor?.label;
        },
        get icon(){
            return this.tensor?.icon;
        },
        async showData(e, data){
            let {result} = await ODA.showDropdown('textarea', {value: JSON.stringify(data), cols: (Math.max(...this.tensor.shape) || 10) * 2 + this.tensor.shape.length * 2, rows: Math.max(...this.tensor.shape) || 1}, {parent: e.target})
        }

    })
    function tensor(...params){
        return new Tensor(...params);
    }
</script>