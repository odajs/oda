<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<script type="module">
    import {Tensor} from './tor.js';
    let N = 100;
    let K = 120;
    let X = Tensor.random([N, K], .2);
    const t = [X,X,X];
    const data = new Float32Array(K ** 3);
    const out = Tensor.from(data);
    out.reshape([K,K,K])
    console.time('out')
    let _j = K;
    let _l = K;
    let _k = K;
    let _i = N;
    let t0 = t[0].data;
    let t1 = t[1].data;
    let t2 = t[2].data;
    let grad0 = t[0].grad;
    let grad1 = t[1].grad;
    let grad2 = t[2].grad;
    let idx = 0;
    let i, j, k, l;
    j = _j;
    while(--j){
        l = _l;
        while(--l){
            k = _k;
            while(--k){
                let v0 = 0;
                let v1 = 0;
                let v2 = 0;
                i = _i;
                while(--i){
                    v1 += t1[k + _k * (i)];
                    v2 += t2[l + _l * (i)];
                    v0 += t0[j + _j * (i)];
                }
                let g = out.grad[idx]/1.618;
                let v = (v0 * v1 * v2) * g;
                v0 = v / v0;
                v1 = v / v1;
                v2 = v / v2;
                i = _i;
                while(--i){
                    grad0[j + _j * (i)] += v0;
                    grad1[k + _k * (i)] += v1;
                    grad2[l + _l * (i)] += v2;
                }
                idx++;
            }
        }
    }
    console.log(out)
    console.timeEnd('out');
    console.log(X);

</script>