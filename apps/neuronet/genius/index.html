<meta charset="UTF-8">
<title>Title</title>
<gen-layout></gen-layout>
<script type="module">
    import '../../../oda.js'
    import * as gen from './genius.js'
    import * as nn from './tor.js';
    import * as mm from './module.js';
    // import {TNum} from './num.js';
    ODA({is: 'gen-layout', imports: '@oda/app-layout', extends: 'oda-app-layout',
        template:`
            <style>
                button{
                    cursor: pointer;
                }
                span{
                    font-size: xx-small;
                    font-family: monospace;
                }
                textarea{
                    font-size: xx-small;
                    font-family: monospace;
                }
            </style>
            <div class="vertical dark" slot="left-panel" opened style="padding: 8px">
                <div class="horizontal">
                    <oda-button icon="eva:f-eye" allow-toggle ::toggled="showMain"></oda-button>
                    <oda-button icon="icons:arrow-forward" allow-toggle ::toggled="isNext"></oda-button>
                </div>

                <div class="vertical flex">
                    prompt:
                    <textarea class="flex" content ::value></textarea>
                </div>
                <div ~if="false" class="flex vertical">
                    tokens:
                    <textarea class="flex" content>{{vectors?.toString(true)}}</textarea>

                </div>
                <div class="horizontal header">
                    <oda-button class="flex" @tap="step" class="flex" icon="av:skip-next"></oda-button>
                    <oda-button style="width: 100px;" allow-toggle ::toggled="goSteps" :icon="goSteps?'av:stop':'av:play-arrow'">{{stepCount}}</oda-button>
                </div>
                <textarea flex content :value="result"></textarea>
                <span>speed: {{learnSpeed.toExponential(4)}}</span>
                <span>error:  {{err.toExponential(4)}}</span>
            </div>
            <div ~if="showMain"  slot="main" class="flex vertical" style="overflow: hidden;">
                <div class="horizontal header">
                    <oda-button @tap="focusedPanel = 0" :focused="focusedPanel === 0">Model</oda-button>
                    <oda-button @tap="focusedPanel = 1" :focused="focusedPanel === 1">Graph</oda-button>
                    <oda-button @tap="focusedPanel = 2" :focused="focusedPanel === 2">Tests</oda-button>
                </div>
                <textarea ~if="focusedPanel === 0" class="flex" content   style="font-size: xx-small; font-family: monospace; ">{{model?.toString()}}</textarea>
                <div ~if="focusedPanel === 1" class="flex  vertical" style="overflow: auto;">
                    <gen-tensor-tree raised ~if="tensor" :tensor></gen-tensor-tree>
                </div>

                <gen-test class="flex" ~if="focusedPanel === 2" class="flex"></gen-test>
                <span class="no-flex header">Parameters: {{paramCount.toLocaleString()}}</span>
            </div>
        `,
        showMain:{
            $def: true,
            $save: true
        },
        stepCount: 0,
        learnSpeed: .01,
        focusedPanel: {
            $def: 0,
            $save: true
        },
        correct:0,
        err:{
            $def: 0,
            set(n, o=0){
                // this.correct = Math.round(o-n) * this.learnSpeed * this.learnSpeed + this.correct;
                // this.learnSpeed += this.correct;
                // this.correct *= this.learnSpeed;
                // this.learnSpeed -= (n-o) * this.learnSpeed * .1
            }
        },
        tensor: null,
        steps(){
            if (this.value === this.result)
                this.goSteps = false;
            if (!this.goSteps) return;
            setTimeout(()=>{
                this.step();
                this.steps();
            })
        },
        set goSteps(n) {
            if (n)
                this.steps();
        },
        get paramCount(){
            return this.tensor?.topo?.reduce((r, v)=> {
                return r + v.paramCount
            }, 0) || 0;
        },
        isNext: {
            $def: 0,
            $save: true
        },
        step(){
            let result = [];
            this.model.module.resetH();
            for(let phrase of this.vectors.toArray){
                for(let i = 0; i<phrase.length; i++) {
                    let token = phrase[i];
                    let next = phrase[i+1] || Array(token.length).fill(0);
                    let res = this.model(token);
                    if(next) {
                        this.tensor = res.mse(this.isNext ? next : token);
                        this.tensor.back(this.learnSpeed);
                        let err = this.tensor.pow(2);
                        this.err = nn.Tensor.einsum('i->', err).data;
                    }
                    result.push(res);
                }
            }
            result = result.map(w=>{
                return this._decoder(w.data);
            })
            this.result = result.join('');
            this.stepCount++;
        },
        result: '',
        value:{
            $def: '',
            $save: true
        },
        model:{
            $pdp: true,
            get(){
                return new gen.Genius();
            }

        },
        get _tokenizer(){
            return new gen.Tokenizer();
        },
        get tokens(){
            return this._tokenizer(this.value)
        },
        get _encoder(){
            return new gen.WordEncoder();
        },
        get _decoder(){
            return new gen.WordDecoder();
        },
        get vectors(){
            const phrases = this.tokens.map(w=>{
                return this._encoder(w);
            })
            return new nn.Tensor(phrases)
        }
    })
    ODA({is: 'gen-tensor-tree',
        template: `
            <style>
                :host{
                    @apply --raised;
                    /*border-right: 1px solid black;*/
                    /*border-top: 1px solid black;*/
                    @apply --vertical;
                    @apply --no-flex;
                }
                span{
                    overflow: hidden;
                    text-overflow: ellipsis;
                    padding: 4px;
                    white-space: pre-wrap;
                    font-family: monospace;
                }
            </style>
            <div class="border header bold horizontal" style="position: sticky; top: 0px;">
                <span>{{tensor?.id}}</span><oda-icon @tap="closed = !closed" :icon></oda-icon>
                <span  no-flex>{{tensor?.label}}</span>
            </div>

            <div ~if="!closed" vertical style="position: sticky; top: 32px;">
                <div class="vertical flex">
                    <span no-flex>{{tensor?.toString()}}</span>
                    <span disabled header>{{tensor?.g?.toString()}}</span>
                </div>
                <div ~if="children?.length" class="no-flex horizontal">
                    <gen-tensor-tree ~for="children" :tensor="$for.item"></gen-tensor-tree>
                </div>
            </div>
        `,

        closed:{
            set(n){
                this.tensor.closed = n
            },
            get(){
                return this.tensor?.closed || false
            }
        },
        tensor: null,
        get children(){
            return this.tensor?.children;
        },
        info:{
            $attr: true,
            get() {
                return this.tensor?.isParam;
            }
        },
        get icon(){
            return this.closed?'icons:chevron-right':'icons:chevron-right:90'
        }

    })
    ODA({is: 'gen-test',
        template:`
            <style>
                :host{
                    @apply --vertical;
                }
            </style>
            <textarea class="flex" ::value  style="font-size: xx-small; font-family: monospace;"></textarea>
            <textarea class="flex" style="font-size: xx-small; font-family: monospace;">{{result}}</textarea>
        `,
        value:{
            $def: '',
            $save: true
        },
        get result(){
            try{
                const fn = new Function('mm', 'nn', 'TNum', this.value);
                return fn.call(this, mm, nn, TNum)|| '';
            }
            catch (e){
                return e;
            }
        }
    })
</script>

