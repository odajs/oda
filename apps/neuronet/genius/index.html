<meta charset="UTF-8">
<title>Title</title>
<gen-layout></gen-layout>
<script type="module">
    import '../../../oda.js'
    import * as gen from './genius.js'
    import * as nn from  '../neuro/neuro.js';
    ODA({is: 'gen-layout', imports: '@oda/app-layout', extends: 'oda-app-layout',
        template:`
            <div class="vertical dark" slot="left-panel" opened style="padding: 8px">
                <div class="vertical">
                    prompt:
                    <textarea content ::value></textarea>
                </div>
                <div class="vertical">
                    tokens:
                    <div class="horizontal" ~for="tokens"  style="font-size: xx-small;">
                        {{JSON.stringify($for.item)}}
                    </div>
                </div>
                <div class="flex vertical">
                    tokens:
                    <textarea class="flex" content   style="font-size: xx-small; font-family: monospace; ">{{vectors?.toString()}}</textarea>

                </div>
                <button @tap="go">go</button>
                <textarea rows="15" content :value="result" style="font-size: xx-small;"></textarea>
                {{err}}
            </div>
            <div slot="main" class="flex vertical" style="overflow: hidden;">
                <div class="horizontal header">
                    <oda-button @tap="focusedPanel = 0" :focused="focusedPanel === 0">Model</oda-button>
                    <oda-button @tap="focusedPanel = 1" :focused="focusedPanel === 1">Graph</oda-button>
                </div>
                <textarea ~if="focusedPanel === 0" class="flex" content   style="font-size: xx-small; font-family: monospace; ">{{model?.toString()}}</textarea>
                <gen-func-graph ~if="focusedPanel === 1" :tensor></gen-func-graph>

            </div>

        `,
        focusedPanel: {
            $def: 0,
            $save: true
        },
        err: '',
        tensor: null,
        go(){
            let result = [];
            for(let phrase of this.vectors.data){
                for(let i = 0; i<phrase.length; i++) {
                    let token = phrase[i];
                    let next = phrase[i+1] || Array(token.length).fill(0);
                    // console.time('work');
                    token = this.model(token);
                    if(next){
                        this.tensor = token._mse(next);
                        this.tensor.back();
                        this.err = this.tensor.data;
                    }
                    // console.timeEnd('work');
                    result.push(token);
                }
            }
            const decoder = new gen.WordDecoder();
            this.result = result.join('\r\n');
            result = result.map(w=>{
                // console.log(w.data)
                return decoder(w.data);
            })
            this.result += '\r\n'+result.join(' ');
        },
        result: '',
        value:{
            $def: '',
            $save: true
        },
        get model(){
            return new gen.Genius();
        },
        get tokens(){
            const tokenizer = new gen.Tokenizer();
            return  tokenizer(this.value);
        },
        get vectors(){
            const encoder = new gen.WordEncoder();
            const phrases = this.tokens.map(r=>{
                return r.map(w=>{
                    return encoder(w);
                })
            })
            return new nn.Tensor(phrases)
        }
    })
    ODA({is: 'gen-func-graph',
        template:`
            <style>
                :host{
                    position: relative;
                    font-size: xx-small;
                    @apply --vertical;
                    @apply --flex;
                    border-left: 1px solid silver;
                    overflow: hidden;
                }
                span{
                    overflow: hidden;
                    text-overflow: ellipsis;
                    padding: 4px;
                }
            </style>
            <div class="flex vertical" style="overflow-y: auto">
                <div ~for="tensor?.topo"  class="border horizontal">
                    <span flex :success-invert="$for.item?.isParam" style="min-width: 50%; max-width: 50%;" :title="$for.item?.toString()">{{$for.item?.toString()}}</span>
                    <span flex dark :title="$for.item?.grad.toTensorString()">{{$for.item?.grad.toTensorString()}}</span>
                </div>
            </div>
            <span class="no-flex header">Parameters: {{paramCount.toLocaleString()}}</span>
        `,
        tensor: null,
        get paramCount(){
            return this.tensor?.topo?.reduce((r, v)=> {
                return r + v.paramCount
            }, 0) || 0;
        }
    })

</script>

