<meta charset="UTF-8">
<title>Title</title>
<gen-layout></gen-layout>
<script type="module">
    import '../../../oda.js'
    import * as gen from './genius.js'
    import * as nn from './ten.js';
    import * as mm from './module.js';
    ODA({is: 'gen-layout', imports: '@oda/app-layout', extends: 'oda-app-layout',
        template:`
            <style>
                button{
                    cursor: pointer;
                }
                span{
                    font-size: xx-small;
                    font-family: monospace;
                }
                textarea{
                    font-size: xx-small;
                    font-family: monospace;
                }
            </style>
            <div class="vertical dark" slot="left-panel" opened style="padding: 8px">
                <div class="vertical flex">
                    prompt:
                    <textarea class="flex" content ::value></textarea>
                </div>
                <div ~if="false" class="flex vertical">
                    tokens:
                    <textarea class="flex" content>{{vectors?.toString(true)}}</textarea>

                </div>
                <div class="horizontal header">
                    <oda-button class="flex" @tap="step" class="flex" icon="av:skip-next"></oda-button>
                    <oda-button style="width: 100px;" allow-toggle ::toggled="goSteps" :icon="goSteps?'av:stop':'av:play-arrow'">{{stepCount}}</oda-button>
                </div>
                <textarea flex content :value="result"></textarea>
                <span>speed: {{learnSpeed}}</span>
                <span>error: {{err}}</span>
            </div>
            <div  slot="main" class="flex vertical" style="overflow: hidden;">
                <div class="horizontal header">
                    <oda-button @tap="focusedPanel = 0" :focused="focusedPanel === 0">Model</oda-button>
                    <oda-button @tap="focusedPanel = 1" :focused="focusedPanel === 1">Graph</oda-button>
                    <oda-button @tap="focusedPanel = 2" :focused="focusedPanel === 2">Tests</oda-button>
                </div>
                <textarea ~if="focusedPanel === 0" class="flex" content   style="font-size: xx-small; font-family: monospace; ">{{model?.toString()}}</textarea>
                <gen-func-graph ~if="focusedPanel === 1" :tensor></gen-func-graph>
                <gen-test ~if="focusedPanel === 2" class="flex"></gen-test>

            </div>
        `,
        stepCount: 0,
        learnSpeedCorrection: 0,
        learnSpeed: .01,
        focusedPanel: {
            $def: 0,
            $save: true
        },
        err:{
            $def: 0,
            set(n, o){
                // this.learnSpeed += (n-o)/n * this.learnSpeed;
            }
        },
        tensor: null,
        steps(){
            if (this.value === this.result)
                this.goSteps = false;
            if (!this.goSteps) return;
            setTimeout(()=>{
                this.step();
                this.steps();
            })
        },
        set goSteps(n) {
            if (n)
                this.steps();
        },
        step(){
            let result = [];
            for(let phrase of this.vectors.data){
                for(let i = 0; i<phrase.length; i++) {
                    let token = phrase[i];
                    let next = phrase[i+1] || Array(token.length).fill(0);
                    let res = this.model(token);
                    if(next){
                        this.tensor = res._mse(token);
                        this.tensor.back(this.learnSpeed);
                        this.err = this.tensor._pow(2)._sum().data;
                    }
                    result.push(res);
                }
            }
            result = result.map(w=>{
                return this._decoder(w.data);
            })
            this.result = result.join('');
            this.stepCount++;
        },
        result: '',
        value:{
            $def: '',
            $save: true
        },
        model:{
            $pdp: true,
            get(){
                return new gen.Genius();
            }

        },
        get _tokenizer(){
            return new gen.Tokenizer();
        },
        get tokens(){
            return this._tokenizer(this.value)
        },
        get _encoder(){
            return new gen.WordEncoder();
        },
        get _decoder(){
            return new gen.WordDecoder();
        },
        get vectors(){
            const phrases = this.tokens.map(w=>{
                return this._encoder(w);
            })
            return new nn.Tensor([phrases])
        }
    })
    ODA({is: 'gen-func-graph',
        template:`
            <style>
                :host{
                    position: relative;
                    font-size: xx-small;
                    @apply --vertical;
                    @apply --flex;
                    border-left: 1px solid silver;
                    overflow: hidden;
                }
                span{
                    overflow: hidden;
                    text-overflow: ellipsis;
                    padding: 4px;
                    white-space: pre-wrap;
                    font-family: monospace;
                }
            </style>
            <div class="flex vertical" style="overflow-y: auto">
                <div ~for="tensor?.topo"  class="border horizontal" :tensor="$for.item">
                    <span flex :info="$for.item?.isParam">{{$for.index}}: {{$for.item?.toString(true)}}</span>
                    <span dark style="width: 50%">{{$for.item.g.toTensorString()}}</span>
                </div>
            </div>
            <span class="no-flex header">Parameters: {{paramCount.toLocaleString()}}</span>
        `,
        tensor: null,
        get paramCount(){
            return this.tensor?.topo?.reduce((r, v)=> {
                return r + v.paramCount
            }, 0) || 0;
        }
    })
    ODA({is: 'gen-test',
        template:`
            <style>
                :host{
                    @apply --vertical;
                }
            </style>
            <textarea class="flex" ::value  style="font-size: xx-small; font-family: monospace;"></textarea>
            <textarea class="flex" style="font-size: xx-small; font-family: monospace;">{{result}}</textarea>
        `,
        value:{
            $def: '',
            $save: true
        },
        get result(){
            try{
                const fn = new Function('mm', 'nn', this.value);
                return fn.call(this, mm, nn)|| '';
            }
            catch (e){
                return e;
            }
        }
    })
</script>

