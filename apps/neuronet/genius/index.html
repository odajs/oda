<meta charset="UTF-8">
<title>Title</title>
<gen-layout></gen-layout>
<script type="module">
    import '../../../oda.js';
    import {MODEL_DIM, Genius} from './genius.js';
    import {Tensor, LEARNING_RATE} from './tor.js';
    import {EO} from "./einops.js";
    import * as mm from './module.js';
    import {TNum, TFloat} from './num.js';
    import {Tokenizer} from './tokenizer.js';
    ODA({is: 'gen-layout', imports: '@oda/app-layout', extends: 'oda-app-layout',
        template:`
            <style>
                button{
                    cursor: pointer;
                }
                span{
                    font-size: xx-small;
                    font-family: monospace;
                }
                textarea{
                    font-size: xx-small;
                    font-family: monospace;
                }
            </style>
            <gen-vocabulary slot="right-panel"></gen-vocabulary>
            <div class="vertical dark" slot="left-panel" opened style="padding: 8px">
                <div class="horizontal">
                    <oda-button icon="eva:f-eye" allow-toggle ::toggled="showMain"></oda-button>
                    <oda-button icon="icons:arrow-forward" allow-toggle ::toggled="isNext"></oda-button>
                </div>

                <div class="vertical flex">
                    prompt:
                    <textarea class="flex" content ::value></textarea>
                </div>
                <div ~if="false" class="flex vertical">
                    tokens:
                    <textarea class="flex" content>{{vectors?.toString(true)}}</textarea>

                </div>
                <div class="horizontal header">
                    <oda-button class="flex" @tap="step" class="flex" icon="av:skip-next"></oda-button>
                    <oda-button style="width: 100px;" allow-toggle ::toggled="goSteps" :icon="goSteps?'av:stop':'av:play-arrow'">{{stepCount}}</oda-button>
                </div>
                <textarea flex content :value="result"></textarea>
                <span>speed: {{learningRate.toExponential(4)}}</span>
                <span>error:  {{err.toLocaleString('ru-RU', {style: 'percent',  minimumFractionDigits: 2, maximumFractionDigits: 2})}}</span>
            </div>
            <div ~if="showMain"  slot="main" class="flex vertical" style="overflow: hidden;">
                <div class="horizontal header">
                    <oda-button @tap="focusedPanel = 0" :focused="focusedPanel === 0">Model</oda-button>
                    <oda-button @tap="focusedPanel = 1" :focused="focusedPanel === 1">Graph</oda-button>
                    <oda-button @tap="focusedPanel = 2" :focused="focusedPanel === 2">Tests</oda-button>
                </div>
                <textarea ~if="focusedPanel === 0" class="flex" content   style="font-size: xx-small; font-family: monospace; ">{{model?.toString()}}</textarea>
                <div ~if="focusedPanel === 1" class="flex horizontal" style="overflow: auto;">
                    <gen-tensor-tree ~if="tensor" :tensor></gen-tensor-tree>
                </div>
                <gen-test class="flex" ~if="focusedPanel === 2" class="flex"></gen-test>
                <span class="no-flex header">Parameters: {{paramCount.toLocaleString()}}</span>
            </div>
        `,
        get learningRate(){
            return LEARNING_RATE;
        },
        showMain:{
            $def: true,
            $save: true
        },
        stepCount: 0,
        focusedPanel: {
            $def: 0,
            $save: true
        },
        correct:0,
        err: 0,
        steps(){
            if (this.value === this.result)
                this.goSteps = false;
            if (!this.goSteps) return;
            this.step();
            requestAnimationFrame(()=>{
                this.steps();
            })
        },
        set goSteps(n) {
            if (n)
                this.steps();
        },
        get paramCount(){
            return this.tensor?.topo?.reduce((r, v)=> {
                return r + v.paramCount
            }, 0) || 0;
        },
        isNext: {
            $def: false,
            $save: true
        },
        step(){
            let result = [];
            this.model.module.resetH();
            for(let phrase of this.tokens){
                for(let i = 0; i<phrase.length; i++) {
                    let token = phrase[i].emb[0];
                    let next = phrase[i+1]?.emb[0] || Array(token.length).fill(0);
                    let res = this.model(token);
                    if(next) {
                        this.tensor = res.mse(this.isNext ? next : token);
                        this.err = this.tensor.data;
                        this.tensor.back();
                    }
                    result.push(res);
                }
            }
            result = result.map(w=>{
                return this.tokenizer.decode(w.data);
            })
            this.result = result.join('');
            this.stepCount++;
        },
        result: '',
        value:{
            $def: '',
            $save: true
        },
        model:{
            $pdp: true,
            get(){
                return new Genius();
            }

        },
        $pdp:{
            tensor: null,
            get tokenizer(){
                return new Tokenizer();
            },
        },
        get tokens(){
            return this.tokenizer.tokenize(this.value)
        }
    })

    ODA({is: 'gen-tensor-tree',
        template: `
            <style>
                :host{
                    @apply --raised;
                    /*border-right: 1px solid black;*/
                    /*border-top: 1px solid black;*/
                    @apply --vertical;
                    @apply --no-flex;
                }
                span{
                    overflow: hidden;
                    text-overflow: ellipsis;
                    padding: 4px;
                    white-space: pre-wrap;
                    font-family: monospace;
                }
            </style>
            <div class="border header bold horizontal" style="position: sticky; top: 0px;">
                <span>{{tensor?.id}}.</span>
<!--                <oda-icon @tap="closed = !closed" :icon></oda-icon>-->
                <span  no-flex>{{tensor?.label}}</span>
            </div>

            <div ~if="!closed" vertical style="position: sticky; top: 32px;">
                <div class="vertical flex">
                    <span no-flex>{{tensor?.toString(4)}}</span>
                    <span disabled header>{{tensor?.g?.toString(4)}}</span>
                </div>
                <div ~if="children?.length" class="no-flex horizontal">
                    <gen-tensor-tree ~for="children" :tensor="$for.item"></gen-tensor-tree>
                </div>
            </div>
        `,

        closed:{
            set(n){
                this.tensor.closed = n
            },
            get(){
                return this.tensor?.closed || false
            }
        },
        tensor: null,
        get children(){
            return this.tensor?.children;
        },
        info:{
            $attr: true,
            get() {
                return this.tensor?.isParam;
            }
        },
        get icon(){
            return this.closed?'icons:chevron-right':'icons:chevron-right:90'
        }

    })

    ODA({is: 'gen-test',
        template:`
            <style>
                :host{
                    @apply --vertical;
                }
            </style>

            <textarea class="flex" ::value  style="font-size: xx-small; font-family: monospace;"></textarea>
            <button @tap="calc">EXE ({{time}} ms)</button>
            <textarea class="flex" style="font-size: xx-small; font-family: monospace;">{{result.toString()}}</textarea>
        `,
        value:{
            $def: '',
            $save: true
        },
        result: '',
        time: 0,
        calc(){
            this.time = 0;
            this.result = ''
            try{
                const fn = new Function('Tensor', 'EO', 'TFloat', this.value);
                let time = Date.now();
                const res =  fn.call(this, Tensor, EO, TFloat) || '';
                time = Date.now() - time;
                this.result =  res?.toString();
                this.time = time;
            }
            catch (e){
                this.result =  e.message;
                console.error(e);
            }
        }
    })

    ODA({is: 'gen-vocabulary',
        template: `
            <style>
                :host{
                    @apply --vertical;
                    @apply --dark;
                    overflow-y: auto;
                }
                span{
                    padding: 4px;
                    width: 50px;
                }
            </style>
            <div border ~for="tokenizer?.vocabulary" vertical>
                <span no-flex>{{$for.key}}</span>
                <div ~for="$for.item.emb" style="height: 16px;" class="flex" ~style="getBackGradient($$for.item)"></div>
            </div>
        `,
        getBackGradient(vector){
            return {background: `linear-gradient(to right, ${this.getColors(vector)})`}
        },
        getColors(items){
            const getColor = (val)=>{
                return 300 * val;
            }
            return items?.map((val, idx, items)=>{
                return `hsl(${getColor(val)}, 100%, 50%) ${((idx+1)/items.length) * 100}%, hsl(${getColor(items[idx+1] || 0)}, 100%, 50%)  ${((idx+1)/items.length) * 100}%`;
            }).join(', ');
        },
    })
</script>

