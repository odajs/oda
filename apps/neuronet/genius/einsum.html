<meta charset="UTF-8">
<script type="module">
    class Tensor {
        constructor(data, shape) {
            this.data = data;
            this.shape = shape;
            this.size = shape.reduce((acc, dim) => acc * dim, 1);
        }

        static einsum(expr, ...tensors) {
            const inputs = expr.split('->')[0].split(',');
            const output = expr.split('->')[1];

            const axisMap = {};
            tensors.forEach((tensor, i) => {
                inputs[i].split('').forEach(axis => {
                    if (!axisMap[axis]) {
                        axisMap[axis] = tensor.shape[i];
                    } else if (axisMap[axis] !== tensor.shape[i]) {
                        throw new Error(`Inconsistent axis size for axis ${axis}`);
                    }
                });
            });

            const outputShape = output.split('').map(axis => axisMap[axis]);
            const outputData = new Float32Array(outputShape.reduce((acc, dim) => acc * dim, 1));

            const compute = new Function(
                ...tensors.map((_, i) => `t${i}`),
                `
      let outputData = new Float32Array(${outputShape.join(' * ')});
      for (let i = 0; i < outputData.length; i++) {
        let index = ${output.split('').map((_, j) => `i${j} = i % ${outputShape[j]}; i = Math.floor(i / ${outputShape[j]});`).join('')};
        outputData[i] = ${inputs.map((input, i) => `t${i}[${input.split('').map((axis, j) => `index[${j}]`).join(', ')}]`).join(' + ')};
      }
      return new Tensor(outputData, outputShape);
    `
            );

            return compute(...tensors.map(tensor => tensor.data));
        }
    }

    // Пример использования
    const t1 = new Tensor(new Float32Array([1, 2, 3, 4]), [2, 2]);
    const t2 = new Tensor(new Float32Array([5, 6, 7, 8]), [2, 2]);

    const result = Tensor.einsum('ij,ij->', t1, t2);
    console.log(result.data); // 70
</script>
